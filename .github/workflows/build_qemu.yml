name: Build QEMU Android

on:
  workflow_dispatch:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build-qemu:
    name: Build QEMU for ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: aarch64
            target: aarch64-linux-android
            api: 24
          - arch: x86_64
            target: x86_64-linux-android
            api: 24

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Android NDK
        uses: android-actions/setup-android@v3

      - name: Compile Stub Binary (Proof of Concept)
        run: |
          mkdir -p output
          
          # Locate NDK Toolchain
          # android-actions/setup-android sets ANDROID_NDK_HOME
          TOOLCHAIN_BIN="${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin"
          
          if [ "${{ matrix.arch }}" == "aarch64" ]; then
            CC="${TOOLCHAIN_BIN}/aarch64-linux-android${{ matrix.api }}-clang"
          else
            CC="${TOOLCHAIN_BIN}/x86_64-linux-android${{ matrix.api }}-clang"
          fi
          
          echo "Compiling for ${{ matrix.arch }} using $CC"
          
          # Create a simple C program to prove cross-compilation works
          echo '#include <stdio.h>
          int main() { 
            printf("Lindroid Core QEMU (Stub) for ${{ matrix.arch }}\\n"); 
            printf("Architecture verification successful.\\n");
            return 0; 
          }' > qemu.c
          
          # Compile
          $CC qemu.c -o output/qemu-system-${{ matrix.arch }}
          
          # Create dummy qemu-img as well
          cp output/qemu-system-${{ matrix.arch }} output/qemu-img
          
          chmod +x output/qemu-system-${{ matrix.arch }}
          chmod +x output/qemu-img

      - name: Package Binaries
        run: |
          cd output
          zip -r lindroid-core-${{ matrix.arch }}.zip .

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: output/lindroid-core-${{ matrix.arch }}.zip
          tag: ${{ github.ref }}
          overwrite: true
